name: Required Files Check (Push - Prod)

on:
  push:
    branches: [ main ]

jobs:
  required-files-check:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      LOG_GROUP_NAME: "/github-actions/required-files-checker/prod"  # prod log group

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: pip install pyyaml

      - name: Run required files check
        run: python3 check_required_files.py

      - name: Check AWS CLI version
        run: aws --version

      - name: Log success to CloudWatch (prod)
        if: success()
        run: |
          # Use dashes instead of colons so it's a valid CloudWatch logStreamName
          LOG_STREAM_NAME=$(date -u +"%Y-%m-%dT%H-%M-%SZ")

          # Create log group and stream if they don't already exist
          aws logs create-log-group --log-group-name "$LOG_GROUP_NAME" || true
          aws logs create-log-stream --log-group-name "$LOG_GROUP_NAME" --log-stream-name "$LOG_STREAM_NAME" || true

          # Ensure we always have some JSON to log
          if [ -f required-files-report.json ]; then
            REPORT_JSON=$(cat required-files-report.json)
          else
            # Fallback if report file is missing
            REPORT_JSON='{"used_config_file": false, "config_file": null, "required_files": [], "missing_files": [], "error": "required-files-report.json not found"}'
          fi

          # Build a valid JSON array for --log-events using jq
          EVENT_JSON=$(
            jq -n \
              --arg workflow "${{ github.workflow }}" \
              --arg sha "${{ github.sha }}" \
              --arg actor "${{ github.actor }}" \
              --arg event "${{ github.event_name }}" \
              --arg branch "${{ github.ref_name }}" \
              --arg repo "${{ github.repository }}" \
              --argjson report "$REPORT_JSON" \
              --arg ts "$(date +%s%3N)" \
              '[{
                timestamp: ($ts|tonumber),
                message: ({
                  workflow: $workflow,
                  commit_sha: $sha,
                  actor: $actor,
                  event_name: $event,
                  branch: $branch,
                  repository: $repo,
                  required_files_report: $report
                } | tostring)
              }]'
          )

          aws logs put-log-events \
            --log-group-name "$LOG_GROUP_NAME" \
            --log-stream-name "$LOG_STREAM_NAME" \
            --log-events "$EVENT_JSON"
